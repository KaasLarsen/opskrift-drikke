<!doctype html>
<html lang="da">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Guides – opskrift-drikke.dk</title>

    <!-- Tailwind -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com"/>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tema -->
    <link rel="stylesheet" href="/assets/site.css">
    <link rel="stylesheet" href="/assets/mobile-menu.css">

    <!-- Meta -->
    <meta name="description" content="Find inspiration og viden i vores guides om kaffe, te, smoothies, mocktails og meget mere."/>
    <meta property="og:title" content="Guides – opskrift-drikke.dk"/>
    <meta property="og:description" content="Læs vores bedste guides om drikke, maskiner og udstyr."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.opskrift-drikke.dk/pages/guides"/>

    <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
    <link rel="manifest" href="/assets/manifest.json">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"/>

    <!-- Global -->
    <script type="module" src="/js/app.js"></script>
    <script defer src="/js/analytics.js"></script>

    <style>
      .card { border-radius: 1rem; box-shadow: 0 4px 18px rgba(0,0,0,.06); }
      .btn  { border-radius: 1rem; }
      .chip { display:inline-flex; font-size:11px; padding:2px 8px; border-radius:9999px; border:1px solid #fed7aa; color:#9a3412; background:#fff7f2; }
      .search-box {
        background:#fff7f2; border:1px solid #fed7aa; border-radius:1rem;
        padding:.5rem .75rem; display:flex; align-items:center; gap:.5rem;
      }
      .search-box input{ background:transparent; border:none; outline:none; width:100%; color:#1c1917; }
      .search-box:focus-within{ box-shadow:0 0 0 3px rgba(249,115,22,.2); }
      .select { appearance:none; background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .75rem; }
      .select:focus{ outline:none; box-shadow:0 0 0 3px rgba(249,115,22,.2); border-color:#fed7aa; }
      .empty-note{padding:14px;border:1px dashed #e5e7eb;border-radius:12px;background:#fff}
      .debug-box{background:#fff5f5;border:1px solid #fecaca;color:#7f1d1d;border-radius:12px;padding:12px;white-space:pre-wrap;overflow:auto}
    </style>
  </head>

  <body class="bg-stone-50 text-stone-900">
    <div id="header"></div>

    <main class="max-w-6xl mx-auto px-4 py-8">
      <h1 class="text-3xl font-semibold mb-2">Guides</h1>
      <p class="opacity-80 mb-6">Trin-for-trin guides om kaffe, te, smoothies, mocktails, juice, udstyr og meget mere.</p>

      <!-- Søg -->
      <div class="max-w-xl mb-5">
        <div class="search-box">
          <svg class="w-5 h-5 text-orange-500"><use href="/assets/icons.svg#search"/></svg>
          <input type="search" id="guideSearch" placeholder="Søg i guides..." />
        </div>
      </div>

      <!-- Filtre -->
      <div class="flex flex-wrap gap-3 items-center mb-6">
        <select id="filterCategory" class="select">
          <option value="">Alle kategorier</option>
        </select>
        <select id="filterTag" class="select">
          <option value="">Alle emner</option>
        </select>
        <select id="sortBy" class="select">
          <option value="dateDesc">Nyeste først</option>
          <option value="titleAsc">Titel (A–Å)</option>
          <option value="popular">Mest læst</option>
        </select>
      </div>

      <!-- Liste -->
      <div id="guideList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

      <!-- Vis flere -->
      <div class="mt-6 flex justify-center">
        <button id="loadMore" class="btn border bg-white hover:bg-stone-50 px-4 py-2 hidden">Vis flere</button>
      </div>

      <!-- Debug (vises kun hvis indlæsning fejler) -->
      <div id="guideDebug" class="mt-8 hidden">
        <h2 class="font-semibold mb-2 text-red-700">Fejl ved indlæsning af guides</h2>
        <div class="debug-box" id="guideDebugLog"></div>
      </div>
    </main>

    <div id="footer"></div>

    <script type="module">
      const listEl   = document.getElementById('guideList');
      const searchEl = document.getElementById('guideSearch');
      const catEl    = document.getElementById('filterCategory');
      const tagEl    = document.getElementById('filterTag');
      const sortEl   = document.getElementById('sortBy');
      const moreBtn  = document.getElementById('loadMore');

      const dbgWrap  = document.getElementById('guideDebug');
      const dbgLog   = document.getElementById('guideDebugLog');

      const PAGE_CHUNK = 24;
      let guides = [];
      let filtered = [];
      let shown = 0;

      const V = 'guides-v6'; // cache-bust

      async function fetchJson(url){
        const u = url + (url.includes('?') ? '' : `?${V}`);
        try{
          const res = await fetch(u, { cache:'no-cache' });
          return { ok: res.ok, status: res.status, url: u, data: res.ok ? await res.json() : null };
        }catch(err){
          return { ok:false, status:'NETWORK', url: u, data:null, err: String(err) };
        }
      }

      async function loadMany(urls){
        const log = [];
        let all = [];
        for (const u of urls){
          const r = await fetchJson(u);
          log.push(r);
          if (r.ok && Array.isArray(r.data) && r.data.length){
            all = all.concat(r.data);
          }
        }
        return { all, log };
      }

      async function loadGuides(){
        const attempts = [];
        const roots = [
          '/data',            // typisk placering
          '/pages/data',      // fallback
          '/assets/data',     // fallback
          ''                  // roden
        ];

        // chunkede filer
        for (const root of roots){
          attempts.push(`${root}/guides-1.json`);
          for (let i=2;i<=50;i++) attempts.push(`${root}/guides-${i}.json`);
        }

        // enkeltfil-fallback
        for (const root of roots){
          attempts.push(`${root}/guides.json`);
        }

        const { all, log } = await loadMany(attempts);

        if (!all.length){
          dbgWrap.classList.remove('hidden');
          dbgLog.textContent = log.map(r => `${r.ok ? 'OK  ' : 'FAIL'} ${String(r.status).padEnd(6)} ${r.url}`).join('\n');
          listEl.innerHTML = '<div class="empty-note">Ingen guides blev indlæst. Se “Fejl ved indlæsning af guides” herunder for præcis sti/status.</div>';
          return;
        }

        guides = all.map(g => ({
          ...g,
          title: g.title || 'Uden titel',
          intro: g.intro || g.description || '',
          category: g.category || '',
          tags: Array.isArray(g.tags) ? g.tags : [],
          date: g.date || g.lastModified || g.updatedAt || '',
          views: g.views || g.popularity || 0,
          slug: g.slug || g.id || ''
        }));

        buildFilters();
        applyFilters();
        if (searchEl) searchEl.placeholder = `Søg i ${guides.length.toLocaleString('da-DK')} guides...`;
      }

      function buildFilters(){
        const cats = new Set();
        const tags = new Set();
        guides.forEach(g => {
          if (g.category) cats.add(g.category);
          (g.tags||[]).forEach(t => t && tags.add(t));
        });

        catEl.innerHTML = '<option value="">Alle kategorier</option>' +
          [...cats].sort((a,b)=>a.localeCompare(b,'da')).map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

        tagEl.innerHTML = '<option value="">Alle emner</option>' +
          [...tags].sort((a,b)=>a.localeCompare(b,'da')).map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
      }

      function card(g){
        const tags = (g.tags||[]).slice(0,3).map(t=>`<span class="chip">#${escapeHtml(t)}</span>`).join(' ');
        const meta =
          [g.category && `<span class="text-xs text-stone-500">${escapeHtml(g.category)}</span>`,
           g.date && `<span class="text-xs text-stone-500">Opdateret: ${fmtDate(g.date)}</span>`]
          .filter(Boolean).join(' · ');

        return `
          <a href="/pages/guide?slug=${encodeURIComponent(g.slug)}"
             class="relative card block border bg-white p-4 hover:shadow transition rounded-2xl">
            <div class="flex flex-col gap-2">
              <div class="flex gap-2 flex-wrap">${tags}</div>
              <h2 class="text-lg font-semibold leading-snug">${escapeHtml(g.title)}</h2>
              ${g.intro ? `<p class="text-sm text-stone-600 line-clamp-3">${escapeHtml(g.intro)}</p>` : ''}
              ${meta ? `<div class="text-xs mt-1">${meta}</div>` : ''}
              <div class="mt-2">
                <span class="inline-flex items-center gap-1 text-sm text-orange-700">
                  <svg class="w-4 h-4"><use href="/assets/icons.svg#book-open"/></svg> Læs guide
                </span>
              </div>
            </div>
          </a>
        `;
      }

      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function fmtDate(d){ const dt=new Date(d); return isNaN(dt)?'':dt.toLocaleDateString('da-DK',{year:'numeric',month:'short',day:'2-digit'}); }
      function normalize(s){ return (s||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,''); }

      function applyFilters(reset=true){
        const q   = normalize(searchEl.value || '');
        const cat = catEl.value;
        const tag = tagEl.value;

        filtered = guides.filter(g => {
          const text = normalize(`${g.title} ${g.intro} ${(g.tags||[]).join(' ')} ${g.category}`);
          const okQ  = !q || text.includes(q);
          const okC  = !cat || g.category === cat;
          const okT  = !tag || (g.tags||[]).includes(tag);
          return okQ && okC && okT;
        });

        const sort = sortEl.value;
        filtered.sort((a,b)=>{
          if (sort === 'titleAsc') return a.title.localeCompare(b.title,'da');
          if (sort === 'popular')  return (b.views||0) - (a.views||0);
          const da = a.date ? new Date(a.date).getTime() : 0;
          const db = b.date ? new Date(b.date).getTime() : 0;
          return db - da;
        });

        if (reset) shown = 0;
        renderMore();
      }

      function renderMore(){
        const slice = filtered.slice(shown, shown + PAGE_CHUNK);
        if (shown === 0){
          listEl.innerHTML = slice.map(card).join('');
        } else {
          listEl.insertAdjacentHTML('beforeend', slice.map(card).join(''));
        }
        shown += slice.length;

        if (shown < filtered.length){
          moreBtn.classList.remove('hidden');
        } else {
          moreBtn.classList.add('hidden');
          if (filtered.length === 0){
            listEl.innerHTML = '<div class="empty-note">Ingen guides fundet med de valgte filtre/søgning.</div>';
          }
        }
      }

      // events
      searchEl.addEventListener('input', () => applyFilters());
      catEl.addEventListener('change', () => applyFilters());
      tagEl.addEventListener('change', () => applyFilters());
      sortEl.addEventListener('change', () => applyFilters());
      moreBtn.addEventListener('click', renderMore);

      // start
      loadGuides();
    </script>
  </body>
</html>
