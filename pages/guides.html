<!doctype html>
<html lang="da">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Guides – opskrift-drikke.dk</title>

    <!-- Tailwind -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com"/>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Eget theme -->
    <link rel="stylesheet" href="/assets/site.css">
    <link rel="stylesheet" href="/assets/mobile-menu.css">

    <!-- Meta -->
    <meta name="description" content="Find inspiration og viden i vores guides om kaffe, te, smoothies, mocktails og meget mere."/>
    <meta property="og:title" content="Guides – opskrift-drikke.dk"/>
    <meta property="og:description" content="Læs vores bedste guides om drikke, maskiner og udstyr."/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://www.opskrift-drikke.dk/pages/guides"/>

    <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
    <link rel="manifest" href="/assets/manifest.json">
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml"/>

    <!-- Global -->
    <script type="module" src="/js/app.js"></script>
    <script defer src="/js/analytics.js"></script>

    <style>
      .card { border-radius: 1rem; box-shadow: 0 4px 18px rgba(0,0,0,.06); }
      .btn  { border-radius: 1rem; }
      .chip  { display:inline-flex; font-size:11px; padding:2px 8px; border-radius:9999px; border:1px solid #fed7aa; color:#9a3412; background:#fff7f2; }
      .search-box {
        background:#fff7f2; border:1px solid #fed7aa; border-radius:1rem;
        padding:.5rem .75rem; display:flex; align-items:center; gap:.5rem;
      }
      .search-box input{ background:transparent; border:none; outline:none; width:100%; color:#1c1917; }
      .search-box:focus-within{ box-shadow:0 0 0 3px rgba(249,115,22,.2); }
      .select { appearance:none; background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .75rem; }
      .select:focus{ outline:none; box-shadow:0 0 0 3px rgba(249,115,22,.2); border-color:#fed7aa; }
      .empty-note{padding:14px;border:1px dashed #e5e7eb;border-radius:12px;background:#fff}
    </style>
  </head>

  <body class="bg-stone-50 text-stone-900">
    <div id="header"></div>

    <main class="max-w-6xl mx-auto px-4 py-8">
      <h1 class="text-3xl font-semibold mb-2">Guides</h1>
      <p class="opacity-80 mb-6">Trin-for-trin guides om kaffe, te, smoothies, mocktails, juice, udstyr og meget mere.</p>

      <!-- Søg -->
      <div class="max-w-xl mb-5">
        <div class="search-box">
          <svg class="w-5 h-5 text-orange-500"><use href="/assets/icons.svg#search"/></svg>
          <input type="search" id="guideSearch" placeholder="Søg i guides..." />
        </div>
      </div>

      <!-- Filtre -->
      <div class="flex flex-wrap gap-3 items-center mb-6">
        <select id="filterCategory" class="select">
          <option value="">Alle kategorier</option>
        </select>
        <select id="filterTag" class="select">
          <option value="">Alle emner</option>
        </select>
        <select id="sortBy" class="select">
          <option value="dateDesc">Nyeste først</option>
          <option value="titleAsc">Titel (A–Å)</option>
          <option value="popular">Mest læst</option>
        </select>
      </div>

      <!-- Liste -->
      <div id="guideList" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

      <!-- Vis flere -->
      <div class="mt-6 flex justify-center">
        <button id="loadMore" class="btn border bg-white hover:bg-stone-50 px-4 py-2 hidden">Vis flere</button>
      </div>
    </main>

    <div id="footer"></div>

    <script type="module">
      const listEl   = document.getElementById('guideList');
      const searchEl = document.getElementById('guideSearch');
      const catEl    = document.getElementById('filterCategory');
      const tagEl    = document.getElementById('filterTag');
      const sortEl   = document.getElementById('sortBy');
      const moreBtn  = document.getElementById('loadMore');

      const PAGE_CHUNK = 24;
      let guides = [];
      let filtered = [];
      let shown = 0;

      const V = 'guides-v3'; // cache-bust
      const fetchJson = (p) => fetch(p, { cache:'no-cache' }).then(r => r.ok ? r.json() : Promise.reject(new Error(r.status)));

      async function tryMany(urls){
        for (const u of urls){
          try {
            const data = await fetchJson(u + (u.includes('?') ? '' : `?${V}`));
            if (Array.isArray(data) && data.length) return data;
          } catch {}
        }
        return [];
      }

      // --- Loader guides fra flere mulige placeringer ---
      async function loadGuides(){
        let all = [];

        // 1) chunkede /data/guides-*.json
        const dataChunk1 = await tryMany(['/data/guides-1.json']);
        if (dataChunk1.length){
          all = all.concat(dataChunk1);
          // hent /data/guides-2..50
          for (let i=2;i<=50;i++){
            const arr = await tryMany([`/data/guides-${i}.json`]);
            if (!arr.length) break;
            all = all.concat(arr);
          }
        }

        // 2) chunkede i roden /guides-*.json (fallback)
        if (!all.length){
          const rootChunk1 = await tryMany(['/guides-1.json']);
          if (rootChunk1.length){
            all = all.concat(rootChunk1);
            for (let i=2;i<=50;i++){
              const arr = await tryMany([`/guides-${i}.json`]);
              if (!arr.length) break;
              all = all.concat(arr);
            }
          }
        }

        // 3) samlet fil i /data eller roden
        if (!all.length){
          all = await tryMany(['/data/guides.json','/guides.json']);
        }

        if (!all.length){
          listEl.innerHTML = '<div class="empty-note">Kunne ikke indlæse guides (hverken i /data/ eller i roden). Tjek at filerne fx <code>/guides.json</code> eller <code>/guides-1.json</code> ligger online.</div>';
          return;
        }

        guides = all.map(g => ({
          ...g,
          title: g.title || 'Uden titel',
          intro: g.intro || g.description || '',
          category: g.category || '',
          tags: Array.isArray(g.tags) ? g.tags : [],
          date: g.date || g.lastModified || g.updatedAt || '',
          views: g.views || g.popularity || 0,
          slug: g.slug || g.id || ''
        }));

        buildFilters();
        applyFilters();
        if (searchEl) searchEl.placeholder = `Søg i ${guides.length.toLocaleString('da-DK')} guides...`;
      }

      function buildFilters(){
        const cats = new Set();
        const tags = new Set();
        guides.forEach(g => {
          if (g.category) cats.add(g.category);
          (g.tags||[]).forEach(t => t && tags.add(t));
        });

        catEl.innerHTML = '<option value="">Alle kategorier</option>' +
          [...cats].sort((a,b)=>a.localeCompare(b,'da')).map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

        tagEl.innerHTML = '<option value="">Alle emner</option>' +
          [...tags].sort((a,b)=>a.localeCompare(b,'da')).map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
      }

      function card(g){
        const tags = (g.tags||[]).slice(0,3).map(t=>`<span class="chip">#${escapeHtml(t)}</span>`).join(' ');
        const meta =
          [g.category && \`<span class="text-xs text-stone-500">\${escapeHtml(g.category)}</span>\`,
           g.date && \`<span class="text-xs text-stone-500">Opdateret: \${fmtDate(g.date)}</span>\`]
          .filter(Boolean).join(' · ');

        return `
          <a href="/pages/guide?slug=${encodeURIComponent(g.slug)}"
             class="relative card block border bg-white p-4 hover:shadow transition rounded-2xl">
            <div class="flex flex-col gap-2">
              <div class="flex gap-2 flex-wrap">${tags}</div>
              <h2 class="text-lg font-semibold leading-snug">${escapeHtml(g.title)}</h2>
              ${g.intro ? `<p class="text-sm text-stone-600 line-clamp-3">${escapeHtml(g.intro)}</p>` : ''}
              ${meta ? `<div class="text-xs mt-1">${meta}</div>` : ''}
              <div class="mt-2">
                <span class="inline-flex items-center gap-1 text-sm text-orange-700">
                  <svg class="w-4 h-4"><use href="/assets/icons.svg#book-open"/></svg> Læs guide
                </span>
              </div>
            </div>
          </a>
        `;
      }

      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function fmtDate(d){
        const dt = new Date(d);
        if (isNaN(dt)) return '';
        return dt.toLocaleDateString('da-DK', { year:'numeric', month:'short', day:'2-digit' });
      }
      function normalize(s){
        return (s||'').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
      }

      function applyFilters(reset=true){
        const q   = normalize(searchEl.value || '');
        const cat = catEl.value;
        const tag = tagEl.value;

        filtered = guides.filter(g => {
          const text = normalize(\`\${g.title} \${g.intro} \${(g.tags||[]).join(' ')} \${g.category}\`);
          const okQ  = !q || text.includes(q);
          const okC  = !cat || g.category === cat;
          const okT  = !tag || (g.tags||[]).includes(tag);
          return okQ && okC && okT;
        });

        const sort = sortEl.value;
        filtered.sort((a,b)=>{
          if (sort === 'titleAsc') return a.title.localeCompare(b.title,'da');
          if (sort === 'popular')  return (b.views||0) - (a.views||0);
          const da = a.date ? new Date(a.date).getTime() : 0;
          const db = b.date ? new Date(b.date).getTime() : 0;
          return db - da;
        });

        if (reset) shown = 0;
        renderMore();
      }

      function renderMore(){
        const slice = filtered.slice(shown, shown + PAGE_CHUNK);
        if (shown === 0){
          listEl.innerHTML = slice.map(card).join('');
        } else {
          listEl.insertAdjacentHTML('beforeend', slice.map(card).join(''));
        }
        shown += slice.length;

        if (shown < filtered.length){
          moreBtn.classList.remove('hidden');
        } else {
          moreBtn.classList.add('hidden');
          if (filtered.length === 0){
            listEl.innerHTML = '<div class="empty-note">Ingen guides fundet med de valgte filtre/søgning.</div>';
          }
        }
      }

      // events
      searchEl.addEventListener('input', () => applyFilters());
      catEl.addEventListener('change', () => applyFilters());
      tagEl.addEventListener('change', () => applyFilters());
      sortEl.addEventListener('change', () => applyFilters());
      moreBtn.addEventListener('click', renderMore);

      // go
      loadGuides();
    </script>
  </body>
</html>
